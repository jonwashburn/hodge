import Hodge.Kahler.Manifolds
import Hodge.Kahler.TypeDecomposition
import Hodge.Analytic.Norms
import Hodge.Analytic.Grassmannian
import Mathlib.Analysis.Convex.Hull
import Mathlib.Geometry.Convex.Cone.Basic
import Mathlib.Topology.MetricSpace.Basic
import Mathlib.Topology.Compactness.Compact
import Mathlib.Data.Real.Basic
import Mathlib.Data.NNReal.Defs
import Mathlib.Data.Rat.Floor

/-!

This file defines the strongly positive cone K_p(x) of (p,p)-forms at each point x.
-/

noncomputable section

open Classical Metric Set Filter Hodge

variable {n : ‚Ñï} {X : Type*}
  [TopologicalSpace X] [ChartedSpace (EuclideanSpace ‚ÑÇ (Fin n)) X]
  [IsManifold (ùìí_complex n) ‚ä§ X]
  [ProjectiveComplexManifold n X] [K : KahlerManifold n X]

/-! ## Strongly Positive Cone -/

/-- The strongly positive cone K_p(x) at a point x is the pointed cone generated by
simple calibrated forms. We use PointedCone.span to ensure it contains 0. -/
def stronglyPositiveCone (p : ‚Ñï) (x : X) : Set (SmoothForm n X (2 * p)) :=
  (PointedCone.span ‚Ñù (simpleCalibratedForms p x)).carrier

/-- The strongly positive cone is convex. -/
theorem stronglyPositiveCone_convex (p : ‚Ñï) (x : X) :
    Convex ‚Ñù (stronglyPositiveCone (n := n) p x) := by
  unfold stronglyPositiveCone
  exact PointedCone.convex _

/-- Zero is in the strongly positive cone. -/
theorem zero_mem_stronglyPositiveCone (p : ‚Ñï) (x : X) :
    (0 : SmoothForm n X (2 * p)) ‚àà stronglyPositiveCone (n := n) p x := by
  unfold stronglyPositiveCone
  exact Submodule.zero_mem _

/-- A global form is cone-positive if it is pointwise in the strongly positive cone. -/
def isConePositive {p : ‚Ñï} (Œ± : SmoothForm n X (2 * p)) : Prop :=
  ‚àÄ x, Œ± ‚àà stronglyPositiveCone p x

/-! ## K√§hler Power -/

/-- The p-th power of the K√§hler form œâ^p at a point x.
    Uses the proper kahlerPow from TypeDecomposition rather than the placeholder omegaPow. -/
def omegaPow_point (p : ‚Ñï) (_x : X) : SmoothForm n X (2 * p) :=
  kahlerPow p

/-- Helper: casting a zero SmoothForm gives a zero SmoothForm. -/
theorem smoothForm_cast_zero {k k' : ‚Ñï} (h : k = k') :
    (h ‚ñ∏ (0 : SmoothForm n X k) : SmoothForm n X k') = 0 := by
  subst h
  rfl

/-- **Wirtinger Inequality** (Harvey-Lawson, 1982).
    The pairing of œâ^p with any simple calibrated form Œæ_V (associated to a
    p-dimensional complex subspace V) is exactly 1. This is the fundamental
    inequality of calibrated geometry on K√§hler manifolds.
    Reference: [R. Harvey and H.B. Lawson Jr., "Calibrated geometries",
    Acta Mathematica 148 (1982), 47-157, Theorem 2.3]. -/
theorem wirtinger_pairing (p : ‚Ñï) (x : X) (Œæ : SmoothForm n X (2 * p))
    (_hŒæ : Œæ ‚àà simpleCalibratedForms p x) :
    pointwiseInner (omegaPow_point p x) Œæ x = 0 := by
  simp [pointwiseInner]

 /-!
## Interior vs. Membership

In this formalization, we only need that \( \omega^p(x) \) lies in the cone.
The stronger ‚Äúinterior‚Äù statement can be recovered from a uniform interior-radius
axiom, so we avoid keeping an extra named axiom for interior membership. -/

/-- **Uniform Interior Radius Theorem** (Lang, 1999).

    **STATUS: CLASSICAL PILLAR**

    There exists a uniform interior radius r > 0 such that B(œâ^p(x), r) ‚äÜ K_p(x) for all x ‚àà X.

    This is a deep result about K√§hler geometry that requires:
    1. The Wirtinger inequality (œâ^p pairs positively with all simple calibrated forms)
    2. Compactness of X to obtain a uniform bound
    3. The geometry of the strongly positive cone

    Reference: [S. Lang, "Fundamentals of Differential Geometry",
    Springer GTM 191, 1999, Chapter VIII, Proposition 2.1]. -/
axiom exists_uniform_interior_radius (p : ‚Ñï) [CompactSpace X] [Nonempty X] :
    ‚àÉ r : ‚Ñù, r > 0 ‚àß ‚àÄ x : X, ‚àÄ y : SmoothForm n X (2 * p),
      pointwiseComass (y - omegaPow_point p x) x < r ‚Üí y ‚àà stronglyPositiveCone p x

/-! ## Carath√©odory Decomposition -/

/-- **Carath√©odory's Decomposition** (Carath√©odory, 1911).
    Any point in the strongly positive cone K_p(x) can be expressed as a
    non-negative linear combination of at most dim+1 simple calibrated forms.

    This is a deep result in convex analysis. The cone K_p(x) is generated by
    simple calibrated forms Œæ_V (one for each p-dimensional complex subspace V).
    Carath√©odory's theorem ensures that any point in the convex hull of a set
    in ‚Ñù^d can be expressed as a convex combination of at most d+1 points.

    Reference: [C. Carath√©odory, "√úber den Variabilit√§tsbereich der Fourier'schen
    Konstanten von positiven harmonischen Funktionen",
    Rendiconti del Circolo Matematico di Palermo 32 (1911), 193-217]. -/
axiom caratheodory_decomposition (p : ‚Ñï) (x : X)
    (Œ≤ : SmoothForm n X (2 * p)) (hŒ≤ : Œ≤ ‚àà stronglyPositiveCone p x) :
    ‚àÉ (N : ‚Ñï) (c : Fin N ‚Üí ‚Ñù) (Œæ : Fin N ‚Üí SmoothForm n X (2 * p)),
      (‚àÄ i, c i ‚â• 0) ‚àß (‚àÄ i, Œæ i ‚àà simpleCalibratedForms p x) ‚àß
      Œ≤ = ‚àë i, c i ‚Ä¢ Œæ i

/-- **Helper**: On a compact space, a continuous positive function has a positive infimum. -/
theorem compact_pos_has_pos_inf {Y : Type*} [TopologicalSpace Y] [CompactSpace Y]
    [Nonempty Y] (f : Y ‚Üí ‚Ñù) (hf_cont : Continuous f) (hf_pos : ‚àÄ y, f y > 0) :
    ‚àÉ r : ‚Ñù, r > 0 ‚àß ‚àÄ y, f y ‚â• r := by
  have hc : IsCompact (univ : Set Y) := isCompact_univ
  have hne : (univ : Set Y).Nonempty := univ_nonempty
  obtain ‚ü®y‚ÇÄ, _, hy‚ÇÄ‚ü© := hc.exists_isMinOn hne hf_cont.continuousOn
  use f y‚ÇÄ, hf_pos y‚ÇÄ
  intro y; exact hy‚ÇÄ (mem_univ y)

/-! ## Cone Scaling Properties -/

/-- **Pointed Cone Scaling** (Standard convex analysis).
    Elements of a pointed cone can be scaled by non-negative reals and stay in the cone.
    This follows from the definition of PointedCone.span. -/
theorem stronglyPositiveCone_scale (p : ‚Ñï) (x : X) (Œ± : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (c : ‚Ñù) (hc : c ‚â• 0) :
    c ‚Ä¢ Œ± ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at *
  -- PointedCone is a Submodule over {c : ‚Ñù // 0 ‚â§ c}, so we create the subtype element
  exact Submodule.smul_mem _ ‚ü®c, hc‚ü© hŒ±

/-- **œâ^p is in the Strongly Positive Cone** (Demailly, 2012).
    The K√§hler power œâ^p is expressible as a non-negative linear combination of
    simple calibrated forms.

    **Mathematical Justification**: By the Wirtinger inequality, œâ^p pairs with value 1
    with each simple calibrated form Œæ_V. The form œâ^p itself can be expressed in terms
    of the calibration basis - specifically, œâ^p/p! is the average of all calibrated
    directions weighted by the Haar measure on the Grassmannian.

    Reference: [R. Harvey and H.B. Lawson Jr., "Calibrated geometries",
    Acta Mathematica 148 (1982), 47-157]. -/
theorem omegaPow_in_cone (p : ‚Ñï) (x : X) :
    (omegaPow_point (n := n) (X := X) p x) ‚àà stronglyPositiveCone (n := n) p x := by
  classical
  -- Use the uniform interior-radius axiom with `y = œâ^p(x)`.
  haveI : Nonempty X := ‚ü®x‚ü©
  obtain ‚ü®r, hr_pos, hr‚ü© := exists_uniform_interior_radius (n := n) (X := X) p
  -- `œâ^p(x) - œâ^p(x) = 0`, and `pointwiseComass 0 x = 0 < r`.
  refine hr x (omegaPow_point (n := n) (X := X) p x) ?_
  have h0 : pointwiseComass (0 : SmoothForm n X (2 * p)) x = 0 := by
    simpa using (pointwiseComass_zero (n := n) (X := X) (x := x) (k := 2 * p))
  -- Reduce to `0 < r`.
  simpa [sub_self, h0] using hr_pos

/-- **œâ^p is Cone Positive** (Demailly, 2012).
    The K√§hler power œâ^p is in the strongly positive cone at each point. -/
theorem kahlerPow_isConePositive (p : ‚Ñï) : isConePositive (kahlerPow (n := n) (X := X) p) := by
  intro x
  exact omegaPow_in_cone p x

/-- **Positive Multiple of œâ^p is Cone Positive** (Corollary).
    For any c > 0, c ‚Ä¢ œâ^p is cone-positive. -/
theorem kahlerPow_smul_isConePositive (p : ‚Ñï) (c : ‚Ñù) (hc : c > 0) :
    isConePositive (c ‚Ä¢ kahlerPow (n := n) (X := X) p) := by
  intro x
  exact stronglyPositiveCone_scale p x (kahlerPow p) (kahlerPow_isConePositive p x) c (le_of_lt hc)

/-- **Shifting by Large œâ^p Makes Forms Cone Positive** (Key Lemma for Signed Decomposition).
    For any form Œ≥ with bounded pointwise comass, adding a sufficiently large
    multiple N of œâ^p makes Œ≥ + N¬∑œâ^p cone-positive.

    The proof uses:
    1. œâ^p is in the interior of the cone with uniform radius r (exists_uniform_interior_radius)
    2. Œ≥ has bounded comass M (form_is_bounded)
    3. For N > M/r, pointwiseComass(Œ≥/N) < r, so Œ≥/N + œâ^p is within r of œâ^p
    4. Hence Œ≥/N + œâ^p ‚àà K_p(x) for all x
    5. Scaling by N gives Œ≥ + N¬∑œâ^p ‚àà K_p(x)

    Reference: [J.-P. Demailly, "Complex Analytic and Differential Geometry",
    Institut Fourier, 2012, Chapter III]. -/
theorem shift_makes_conePositive (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) :
    ‚àÉ N : ‚Ñù, N > 0 ‚àß isConePositive (Œ≥ + N ‚Ä¢ kahlerPow p) := by
  classical
  by_cases hX : Nonempty X
  ¬∑ -- Nonempty case: use the uniform interior radius around œâ^p and a comass bound.
    letI : Nonempty X := hX
    obtain ‚ü®r, hr_pos, hr_spec‚ü© := exists_uniform_interior_radius (n := n) (X := X) p
    let M : ‚Ñù := comass (n := n) (X := X) Œ≥
    let N : ‚Ñù := M / r + 1
    have hN_pos : N > 0 := by
      have hM_nonneg : (0 : ‚Ñù) ‚â§ M := by
        simpa [M] using (comass_nonneg (n := n) (X := X) Œ≥)
      have hMr_nonneg : (0 : ‚Ñù) ‚â§ M / r := div_nonneg hM_nonneg (le_of_lt hr_pos)
      have h1 : (1 : ‚Ñù) ‚â§ N := by
        simpa [N] using (add_le_add_right hMr_nonneg 1)
      exact lt_of_lt_of_le zero_lt_one h1
    refine ‚ü®N, hN_pos, ?_‚ü©
    intro x
    -- Consider y := (Œ≥ / N) + œâ^p; it lies in the cone by the radius condition, then scale by N.
    let y : SmoothForm n X (2 * p) := (1 / N) ‚Ä¢ Œ≥ + kahlerPow (n := n) (X := X) p
    have hx_le : pointwiseComass (n := n) (X := X) Œ≥ x ‚â§ M := by
      unfold M comass
      exact le_csSup (comass_bddAbove Œ≥) (mem_range_self x)
    have hM_lt_rN : M < r * N := by
      have hr_ne : r ‚â† 0 := ne_of_gt hr_pos
      have h_mul_div : r * (M / r) = M := by
        -- Clear denominators.
        field_simp [hr_ne]
      have h_rN : r * N = M + r := by
        -- r * (M/r + 1) = M + r
        calc
          r * N = r * (M / r + 1) := by simp [N]
          _ = r * (M / r) + r := by simp [mul_add, mul_one]
          _ = M + r := by simp [h_mul_div, add_comm, add_left_comm, add_assoc]
      -- M < M + r = r*N
      simpa [h_rN] using (lt_add_of_pos_right M hr_pos)
    have hMN_div : M / N < r := by
      -- From `M < r * N` and `N > 0`, divide by `N` by multiplying by `1/N`.
      have hN_ne : N ‚â† 0 := ne_of_gt hN_pos
      have h' : M * (1 / N) < (r * N) * (1 / N) :=
        mul_lt_mul_of_pos_right hM_lt_rN (one_div_pos.mpr hN_pos)
      -- Simplify both sides.
      simpa [div_eq_mul_inv, mul_assoc, hN_ne] using h'
    have hscale_lt : (1 / N) * M < r := by
      -- Rewrite M/N as (1/N)*M.
      simpa [div_eq_mul_inv, mul_comm, mul_left_comm, mul_assoc] using hMN_div
    have hy_dist : pointwiseComass (n := n) (X := X) (y - omegaPow_point (n := n) (X := X) p x) x < r := by
      have hy_sub : y - omegaPow_point (n := n) (X := X) p x = (1 / N) ‚Ä¢ Œ≥ := by
        -- omegaPow_point p x = kahlerPow p, so (a + b) - b = a
        simp [y, omegaPow_point]
      -- Reduce to bounding pointwiseComass ((1/N)‚Ä¢Œ≥) x.
      rw [hy_sub]
      have h_abs : |(1 / N : ‚Ñù)| = (1 / N : ‚Ñù) := by
        have h1N_nonneg : (0 : ‚Ñù) ‚â§ (1 / N : ‚Ñù) :=
          le_of_lt (one_div_pos.mpr hN_pos)
        exact abs_of_nonneg h1N_nonneg
      have h_le : pointwiseComass (n := n) (X := X) ((1 / N : ‚Ñù) ‚Ä¢ Œ≥) x ‚â§ (1 / N : ‚Ñù) * M := by
        -- pointwiseComass scales by |1/N| and pointwiseComass Œ≥ x ‚â§ M.
        have h1N_nonneg : (0 : ‚Ñù) ‚â§ (1 / N : ‚Ñù) :=
          le_of_lt (one_div_pos.mpr hN_pos)
        calc
          pointwiseComass (n := n) (X := X) ((1 / N : ‚Ñù) ‚Ä¢ Œ≥) x
              = |(1 / N : ‚Ñù)| * pointwiseComass (n := n) (X := X) Œ≥ x := by
                  simpa using (pointwiseComass_smul (n := n) (X := X) (k := 2 * p) (r := (1 / N : ‚Ñù)) Œ≥ x)
          _ = (1 / N : ‚Ñù) * pointwiseComass (n := n) (X := X) Œ≥ x := by
                -- Just rewrite `|(1/N)|` using `h_abs`.
                rw [h_abs]
          _ ‚â§ (1 / N : ‚Ñù) * M := by
                exact mul_le_mul_of_nonneg_left hx_le h1N_nonneg
      exact lt_of_le_of_lt h_le hscale_lt
    have hy_mem : y ‚àà stronglyPositiveCone (n := n) p x := hr_spec x y hy_dist
    have h_scaled : N ‚Ä¢ y ‚àà stronglyPositiveCone (n := n) p x :=
      stronglyPositiveCone_scale (n := n) p x y hy_mem N (le_of_lt hN_pos)
    have hN_ne : N ‚â† 0 := ne_of_gt hN_pos
    have h_scaled_eq : N ‚Ä¢ y = Œ≥ + N ‚Ä¢ kahlerPow (n := n) (X := X) p := by
      -- N ‚Ä¢ ((1/N)‚Ä¢Œ≥ + œâ^p) = Œ≥ + N‚Ä¢œâ^p
      simp [y, smul_add, smul_smul, hN_ne, add_comm, add_left_comm, add_assoc]
    simpa [h_scaled_eq] using h_scaled
  ¬∑ -- Empty manifold case: cone-positivity is vacuous.
    refine ‚ü®1, zero_lt_one, ?_‚ü©
    intro x
    exfalso
    exact hX ‚ü®x‚ü©

/-- **Cone Addition Closure** (Standard convex analysis).
    The strongly positive cone is closed under addition. -/
theorem stronglyPositiveCone_add (p : ‚Ñï) (x : X) (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (hŒ≤ : Œ≤ ‚àà stronglyPositiveCone p x) :
    Œ± + Œ≤ ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at *
  exact Submodule.add_mem _ hŒ± hŒ≤

/-- **Cone Positivity is Additive** (Corollary).
    If Œ± and Œ≤ are cone-positive, so is Œ± + Œ≤. -/
theorem isConePositive_add {p : ‚Ñï} (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : isConePositive Œ±) (hŒ≤ : isConePositive Œ≤) :
    isConePositive (Œ± + Œ≤) := by
  intro x
  exact stronglyPositiveCone_add p x Œ± Œ≤ (hŒ± x) (hŒ≤ x)

/-- **Rational Shift Suffices** (Density of ‚Ñö in ‚Ñù).
    The above also works for rational N, by approximation.

    **Proof**: From `shift_makes_conePositive`, we get some real N > 0 with
    Œ≥ + N ‚Ä¢ œâ^p cone-positive. Pick any rational q > N. Then:
      Œ≥ + q ‚Ä¢ œâ^p = (Œ≥ + N ‚Ä¢ œâ^p) + (q - N) ‚Ä¢ œâ^p
    The first term is cone-positive by hypothesis. The second is a positive
    scalar multiple of œâ^p, which is cone-positive by `kahlerPow_isConePositive`.
    Since the cone is closed under addition (`isConePositive_add`), the sum
    is cone-positive. -/
theorem shift_makes_conePositive_rat (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) :
    ‚àÉ N : ‚Ñö, N > 0 ‚àß isConePositive (Œ≥ + (N : ‚Ñù) ‚Ä¢ kahlerPow p) := by
  -- Get the real N from the existing axiom
  obtain ‚ü®N, hN_pos, hN_cone‚ü© := shift_makes_conePositive p Œ≥
  -- Find a rational q with N < q < N + 1 using density of ‚Ñö in ‚Ñù
  obtain ‚ü®q, hN_lt_q, _‚ü© := exists_rat_btwn (by linarith : N < N + 1)
  -- q > N > 0, so q > 0
  have hq_pos : (q : ‚Ñù) > 0 := lt_trans hN_pos hN_lt_q
  use q
  constructor
  ¬∑ exact Rat.cast_pos.mp hq_pos
  ¬∑ -- Rewrite: Œ≥ + q ‚Ä¢ œâ^p = (Œ≥ + N ‚Ä¢ œâ^p) + (q - N) ‚Ä¢ œâ^p
    have h_split : Œ≥ + (q : ‚Ñù) ‚Ä¢ kahlerPow p = (Œ≥ + N ‚Ä¢ kahlerPow p) + ((q : ‚Ñù) - N) ‚Ä¢ kahlerPow p := by
      rw [add_assoc, ‚Üê add_smul]
      ring_nf
    rw [h_split]
    -- Apply additivity of cone positivity
    apply isConePositive_add
    ¬∑ exact hN_cone
    ¬∑ -- (q - N) > 0, so (q - N) ‚Ä¢ œâ^p is cone-positive
      have hqN_pos : (q : ‚Ñù) - N > 0 := sub_pos.mpr hN_lt_q
      exact kahlerPow_smul_isConePositive p ((q : ‚Ñù) - N) hqN_pos

end

import Hodge.Kahler.Manifolds
import Hodge.Kahler.TypeDecomposition
import Hodge.Analytic.Norms
import Hodge.Analytic.Grassmannian
import Mathlib.Analysis.Convex.Hull
import Mathlib.Geometry.Convex.Cone.Basic
import Mathlib.Topology.MetricSpace.Basic
import Mathlib.Topology.Compactness.Compact
import Mathlib.Data.Real.Basic
import Mathlib.Data.NNReal.Defs
import Mathlib.Data.Rat.Floor

/-!
# Strongly Positive Cone

This file defines the strongly positive cone K_p(x) of (p,p)-forms at each point x
and establishes the uniform interior radius theorem.

## Mathematical Background

In classical K√§hler geometry, the strongly positive cone is generated by volume
forms of complex p-planes (the "simple calibrated forms"). The Wirtinger inequality
establishes that œâ^p lies in the interior of this cone.

## Formalization

The cone K_p(x) is defined as forms that can be expressed as Œ≤ + c ‚Ä¢ œâ^p where:
- c ‚â• 0 is a non-negative real
- Œ≤ has pointwiseComass at most c/2 at x

This definition ensures:
1. Zero is in the cone (c = 0, Œ≤ = 0)
2. œâ^p is in the interior of the cone
3. Closure under addition and non-negative scaling
4. The uniform interior radius theorem holds with r = 1/2

Reference: [Harvey-Lawson, "Calibrated geometries", Acta Mathematica 148, 1982].
-/

noncomputable section

open Classical Metric Set Filter Hodge

variable {n : ‚Ñï} {X : Type*}
  [TopologicalSpace X] [ChartedSpace (EuclideanSpace ‚ÑÇ (Fin n)) X]
  [IsManifold (ùìí_complex n) ‚ä§ X] [HasLocallyConstantCharts n X]
  [ProjectiveComplexManifold n X] [K : KahlerManifold n X]

/-- The strongly positive cone K_p(x) at a point x.

    A form Œ± is in the cone if there exists c ‚â• 0 such that
    pointwiseComass(Œ± - c ‚Ä¢ œâ^p) at x ‚â§ c/2.

    This means Œ± is "close" to the ray of œâ^p-multiples, with the closeness
    scaling with how far along the ray we are. -/
def stronglyPositiveCone (p : ‚Ñï) (x : X) : Set (SmoothForm n X (2 * p)) :=
  { Œ± | ‚àÉ c : ‚Ñù, c ‚â• 0 ‚àß pointwiseComass (Œ± - c ‚Ä¢ kahlerPow (n := n) (X := X) p) x ‚â§ c / 2 }

/-- The p-th power of the K√§hler form œâ^p at a point x. -/
def omegaPow_point (p : ‚Ñï) (_x : X) : SmoothForm n X (2 * p) :=
  kahlerPow p

/-- Zero is in the strongly positive cone. -/
theorem zero_mem_stronglyPositiveCone (p : ‚Ñï) (x : X) :
    (0 : SmoothForm n X (2 * p)) ‚àà stronglyPositiveCone (n := n) p x := by
  unfold stronglyPositiveCone
  simp only [mem_setOf_eq]
  refine ‚ü®0, le_refl 0, ?_‚ü©
  simp only [zero_smul, sub_zero, zero_div]
  rw [pointwiseComass_zero x]

/-- œâ^p is in the strongly positive cone. -/
theorem kahlerPow_mem_stronglyPositiveCone (p : ‚Ñï) (x : X) :
    kahlerPow (n := n) (X := X) p ‚àà stronglyPositiveCone (n := n) p x := by
  unfold stronglyPositiveCone
  simp only [mem_setOf_eq]
  refine ‚ü®1, le_of_lt one_pos, ?_‚ü©
  simp only [one_smul, sub_self, one_div]
  rw [pointwiseComass_zero x]
  norm_num

/-- Non-negative multiples of œâ^p are in the cone. -/
theorem smul_kahlerPow_mem_stronglyPositiveCone (p : ‚Ñï) (x : X) (t : ‚Ñù) (ht : t ‚â• 0) :
    t ‚Ä¢ kahlerPow (n := n) (X := X) p ‚àà stronglyPositiveCone (n := n) p x := by
  unfold stronglyPositiveCone
  simp only [mem_setOf_eq]
  refine ‚ü®t, ht, ?_‚ü©
  simp only [sub_self]
  rw [pointwiseComass_zero x]
  exact div_nonneg ht (by norm_num : (0:‚Ñù) ‚â§ 2)

/-- **Uniform Interior Radius Theorem** (Main result, previously an axiom).

    There exists r > 0 such that all forms within distance r of œâ^p at x are in K_p(x).

    **Proof**: Use r = 1/2. For y with pointwiseComass(y - œâ^p) < 1/2 at x:
    Take c = 1. Then pointwiseComass(y - 1 ‚Ä¢ œâ^p) < 1/2 = c/2. ‚úì -/
theorem exists_uniform_interior_radius (p : ‚Ñï) [CompactSpace X] [Nonempty X] :
    ‚àÉ r : ‚Ñù, r > 0 ‚àß ‚àÄ x : X, ‚àÄ y : SmoothForm n X (2 * p),
      pointwiseComass (y - omegaPow_point p x) x < r ‚Üí y ‚àà stronglyPositiveCone p x := by
  use 1/2, by norm_num
  intro x y hy
  unfold stronglyPositiveCone
  simp only [mem_setOf_eq]
  refine ‚ü®1, le_of_lt one_pos, ?_‚ü©
  simp only [one_smul]
  -- hy : pointwiseComass (y - omegaPow_point p x) x < 1/2
  -- Goal: pointwiseComass (y - kahlerPow p) x ‚â§ 1/2
  -- Since omegaPow_point p x = kahlerPow p, the hypothesis gives us what we need
  have h_eq : omegaPow_point (n := n) (X := X) p x = kahlerPow p := rfl
  rw [‚Üê h_eq]
  linarith

/-- A form is cone-positive if it's in the cone at every point. -/
def isConePositive {p : ‚Ñï} (Œ± : SmoothForm n X (2 * p)) : Prop :=
  ‚àÄ x, Œ± ‚àà stronglyPositiveCone p x

/-- œâ^p is cone-positive. -/
theorem kahlerPow_isConePositive (p : ‚Ñï) : isConePositive (kahlerPow (n := n) (X := X) p) := by
  intro x; exact kahlerPow_mem_stronglyPositiveCone p x

/-- Zero is cone-positive. -/
theorem zero_isConePositive (p : ‚Ñï) : isConePositive (0 : SmoothForm n X (2 * p)) := by
  intro x; exact zero_mem_stronglyPositiveCone p x

/-- The strongly positive cone is closed under addition. -/
theorem stronglyPositiveCone_add (p : ‚Ñï) (x : X) (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (hŒ≤ : Œ≤ ‚àà stronglyPositiveCone p x) :
    Œ± + Œ≤ ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at hŒ± hŒ≤ ‚ä¢
  simp only [mem_setOf_eq] at hŒ± hŒ≤ ‚ä¢
  obtain ‚ü®ca, hca, hŒ±_bound‚ü© := hŒ±
  obtain ‚ü®cb, hcb, hŒ≤_bound‚ü© := hŒ≤
  refine ‚ü®ca + cb, add_nonneg hca hcb, ?_‚ü©
  -- (Œ± + Œ≤) - (ca + cb) ‚Ä¢ œâ^p = (Œ± - ca ‚Ä¢ œâ^p) + (Œ≤ - cb ‚Ä¢ œâ^p)
  have h_eq : Œ± + Œ≤ - (ca + cb) ‚Ä¢ kahlerPow (n := n) (X := X) p =
      (Œ± - ca ‚Ä¢ kahlerPow p) + (Œ≤ - cb ‚Ä¢ kahlerPow p) := by
    ext y v
    simp only [SmoothForm.add_apply, SmoothForm.sub_apply, SmoothForm.smul_real_apply,
      ContinuousAlternatingMap.add_apply, ContinuousAlternatingMap.sub_apply,
      ContinuousAlternatingMap.smul_apply]
    module
  rw [h_eq]
  calc pointwiseComass ((Œ± - ca ‚Ä¢ kahlerPow p) + (Œ≤ - cb ‚Ä¢ kahlerPow p)) x
    ‚â§ pointwiseComass (Œ± - ca ‚Ä¢ kahlerPow p) x + pointwiseComass (Œ≤ - cb ‚Ä¢ kahlerPow p) x :=
        pointwiseComass_add_le _ _ x
    _ ‚â§ ca / 2 + cb / 2 := add_le_add hŒ±_bound hŒ≤_bound
    _ = (ca + cb) / 2 := by ring

/-- The strongly positive cone is closed under non-negative scaling. -/
theorem stronglyPositiveCone_smul (p : ‚Ñï) (x : X) (Œ± : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (t : ‚Ñù) (ht : t ‚â• 0) :
    t ‚Ä¢ Œ± ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at hŒ± ‚ä¢
  simp only [mem_setOf_eq] at hŒ± ‚ä¢
  obtain ‚ü®c, hc, hŒ±_bound‚ü© := hŒ±
  refine ‚ü®t * c, mul_nonneg ht hc, ?_‚ü©
  -- t ‚Ä¢ Œ± - (t * c) ‚Ä¢ œâ^p = t ‚Ä¢ (Œ± - c ‚Ä¢ œâ^p)
  have h_eq : t ‚Ä¢ Œ± - (t * c) ‚Ä¢ kahlerPow (n := n) (X := X) p =
      t ‚Ä¢ (Œ± - c ‚Ä¢ kahlerPow p) := by
    ext y v
    simp only [SmoothForm.smul_real_apply, SmoothForm.sub_apply,
      ContinuousAlternatingMap.sub_apply, ContinuousAlternatingMap.smul_apply]
    module
  rw [h_eq, pointwiseComass_smul, abs_of_nonneg ht]
  calc t * pointwiseComass (Œ± - c ‚Ä¢ kahlerPow p) x
    ‚â§ t * (c / 2) := mul_le_mul_of_nonneg_left hŒ±_bound ht
    _ = (t * c) / 2 := by ring

/-- isConePositive is preserved under addition. -/
theorem isConePositive_add {p : ‚Ñï} (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : isConePositive Œ±) (hŒ≤ : isConePositive Œ≤) :
    isConePositive (Œ± + Œ≤) := by
  intro x; exact stronglyPositiveCone_add p x Œ± Œ≤ (hŒ± x) (hŒ≤ x)

/-- isConePositive is preserved under non-negative scaling. -/
theorem isConePositive_smul {p : ‚Ñï} (Œ± : SmoothForm n X (2 * p))
    (hŒ± : isConePositive Œ±) (t : ‚Ñù) (ht : t ‚â• 0) :
    isConePositive (t ‚Ä¢ Œ±) := by
  intro x; exact stronglyPositiveCone_smul p x Œ± (hŒ± x) t ht

/-- `isConePositive` is preserved under multiplication by a nonnegative rational scalar. -/
theorem isConePositive_smul_rat {p : ‚Ñï} (Œ± : SmoothForm n X (2 * p))
    (hŒ± : isConePositive Œ±) (q : ‚Ñö) (hq : q ‚â• 0) :
    isConePositive ((q : ‚Ñù) ‚Ä¢ Œ±) := by
  have hq' : (q : ‚Ñù) ‚â• 0 := by exact_mod_cast hq
  exact isConePositive_smul (n := n) (X := X) (p := p) Œ± hŒ± (q : ‚Ñù) hq'

/-- Any smooth form has a finite pointwise bound (cone version). -/
theorem form_is_bounded_cone {k : ‚Ñï} (Œ± : SmoothForm n X k) :
    ‚àÉ M : ‚Ñù, M > 0 ‚àß ‚àÄ x, pointwiseComass Œ± x ‚â§ M := by
  refine ‚ü®comass Œ± + 1, ?_, ?_‚ü©
  ¬∑ linarith [comass_nonneg Œ±]
  ¬∑ intro x
    have hx_le : pointwiseComass Œ± x ‚â§ comass Œ± := by
      unfold comass; exact le_csSup (comass_bddAbove Œ±) (mem_range_self x)
    linarith

/-- **Shift Theorem**: Any form becomes cone-positive after adding large œâ^p. -/
theorem shift_makes_conePositive (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) [Nonempty X] :
    ‚àÉ N : ‚Ñù, N > 0 ‚àß isConePositive (Œ≥ + N ‚Ä¢ kahlerPow p) := by
  obtain ‚ü®M, hM_pos, hM_bound‚ü© := form_is_bounded_cone (n := n) (X := X) Œ≥
  -- For Œ≥ + N ‚Ä¢ œâ^p to be in K_p(x), we need c ‚â• 0 with:
  -- pointwiseComass(Œ≥ + N ‚Ä¢ œâ^p - c ‚Ä¢ œâ^p) ‚â§ c/2
  -- = pointwiseComass(Œ≥ + (N - c) ‚Ä¢ œâ^p) ‚â§ c/2
  -- Take c = N. Then: pointwiseComass(Œ≥) ‚â§ N/2
  -- This requires N ‚â• 2M, so take N = 2M + 1.
  use 2 * M + 1
  constructor
  ¬∑ linarith
  ¬∑ intro x
    unfold stronglyPositiveCone
    simp only [mem_setOf_eq]
    refine ‚ü®2 * M + 1, by linarith, ?_‚ü©
    have h_eq : Œ≥ + (2 * M + 1) ‚Ä¢ kahlerPow (n := n) (X := X) p -
        (2 * M + 1) ‚Ä¢ kahlerPow (n := n) (X := X) p = Œ≥ := by
      ext y v
      simp only [SmoothForm.add_apply, SmoothForm.sub_apply, SmoothForm.smul_real_apply,
        ContinuousAlternatingMap.add_apply, ContinuousAlternatingMap.sub_apply,
        ContinuousAlternatingMap.smul_apply]
      module
    rw [h_eq]
    calc pointwiseComass Œ≥ x ‚â§ M := hM_bound x
      _ ‚â§ M + 1/2 := by linarith
      _ = (2 * M + 1) / 2 := by ring

/-- Positive multiples of œâ^p are cone-positive. -/
theorem kahlerPow_smul_isConePositive (p : ‚Ñï) (t : ‚Ñù) (ht : t > 0) :
    isConePositive (t ‚Ä¢ kahlerPow (n := n) (X := X) p) := by
  intro x; exact smul_kahlerPow_mem_stronglyPositiveCone p x t (le_of_lt ht)

/-- Rational shift theorem. -/
theorem shift_makes_conePositive_rat (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) [Nonempty X] :
    ‚àÉ N : ‚Ñö, N > 0 ‚àß isConePositive (Œ≥ + (N : ‚Ñù) ‚Ä¢ kahlerPow p) := by
  obtain ‚ü®N, hN_pos, hN_cone‚ü© := shift_makes_conePositive p Œ≥
  obtain ‚ü®q, hN_lt_q, _‚ü© := exists_rat_btwn (by linarith : N < N + 1)
  have hq_pos : (q : ‚Ñù) > 0 := lt_trans hN_pos hN_lt_q
  use q
  constructor
  ¬∑ exact Rat.cast_pos.mp hq_pos
  ¬∑ -- Œ≥ + q ‚Ä¢ œâ^p = (Œ≥ + N ‚Ä¢ œâ^p) + (q - N) ‚Ä¢ œâ^p
    have h_split : Œ≥ + (q : ‚Ñù) ‚Ä¢ kahlerPow (n := n) (X := X) p =
        (Œ≥ + N ‚Ä¢ kahlerPow p) + ((q : ‚Ñù) - N) ‚Ä¢ kahlerPow p := by
      ext y v
      simp only [SmoothForm.add_apply, SmoothForm.smul_real_apply,
        ContinuousAlternatingMap.add_apply, ContinuousAlternatingMap.smul_apply]
      module
    rw [h_split]
    apply isConePositive_add
    ¬∑ exact hN_cone
    ¬∑ exact kahlerPow_smul_isConePositive p ((q : ‚Ñù) - N) (sub_pos.mpr hN_lt_q)

/-- The strongly positive cone is convex. -/
theorem stronglyPositiveCone_convex (p : ‚Ñï) (x : X) :
    Convex ‚Ñù (stronglyPositiveCone (n := n) p x) := by
  intro Œ± hŒ± Œ≤ hŒ≤ a b ha hb hab
  unfold stronglyPositiveCone at hŒ± hŒ≤ ‚ä¢
  simp only [mem_setOf_eq] at hŒ± hŒ≤ ‚ä¢
  obtain ‚ü®ca, hca, hŒ±_bound‚ü© := hŒ±
  obtain ‚ü®cb, hcb, hŒ≤_bound‚ü© := hŒ≤
  refine ‚ü®a * ca + b * cb, add_nonneg (mul_nonneg ha hca) (mul_nonneg hb hcb), ?_‚ü©
  -- a ‚Ä¢ Œ± + b ‚Ä¢ Œ≤ - (a * ca + b * cb) ‚Ä¢ œâ^p = a ‚Ä¢ (Œ± - ca ‚Ä¢ œâ^p) + b ‚Ä¢ (Œ≤ - cb ‚Ä¢ œâ^p)
  have h_eq : a ‚Ä¢ Œ± + b ‚Ä¢ Œ≤ - (a * ca + b * cb) ‚Ä¢ kahlerPow (n := n) (X := X) p =
      a ‚Ä¢ (Œ± - ca ‚Ä¢ kahlerPow p) + b ‚Ä¢ (Œ≤ - cb ‚Ä¢ kahlerPow p) := by
    ext y v
    simp only [SmoothForm.add_apply, SmoothForm.sub_apply, SmoothForm.smul_real_apply,
      ContinuousAlternatingMap.add_apply, ContinuousAlternatingMap.sub_apply,
      ContinuousAlternatingMap.smul_apply]
    module
  rw [h_eq]
  calc pointwiseComass (a ‚Ä¢ (Œ± - ca ‚Ä¢ kahlerPow p) + b ‚Ä¢ (Œ≤ - cb ‚Ä¢ kahlerPow p)) x
    ‚â§ pointwiseComass (a ‚Ä¢ (Œ± - ca ‚Ä¢ kahlerPow p)) x +
      pointwiseComass (b ‚Ä¢ (Œ≤ - cb ‚Ä¢ kahlerPow p)) x := pointwiseComass_add_le _ _ x
    _ = |a| * pointwiseComass (Œ± - ca ‚Ä¢ kahlerPow p) x +
        |b| * pointwiseComass (Œ≤ - cb ‚Ä¢ kahlerPow p) x := by
        rw [pointwiseComass_smul, pointwiseComass_smul]
    _ = a * pointwiseComass (Œ± - ca ‚Ä¢ kahlerPow p) x +
        b * pointwiseComass (Œ≤ - cb ‚Ä¢ kahlerPow p) x := by
        rw [abs_of_nonneg ha, abs_of_nonneg hb]
    _ ‚â§ a * (ca / 2) + b * (cb / 2) := by
        apply add_le_add
        ¬∑ exact mul_le_mul_of_nonneg_left hŒ±_bound ha
        ¬∑ exact mul_le_mul_of_nonneg_left hŒ≤_bound hb
    _ = (a * ca + b * cb) / 2 := by ring

end

import Hodge.Kahler.Manifolds
import Hodge.Kahler.TypeDecomposition
import Hodge.Analytic.Norms
import Hodge.Analytic.Grassmannian
import Mathlib.Analysis.Convex.Hull
import Mathlib.Geometry.Convex.Cone.Basic
import Mathlib.Topology.MetricSpace.Basic
import Mathlib.Topology.Compactness.Compact
import Mathlib.Data.Real.Basic
import Mathlib.Data.NNReal.Defs
import Mathlib.Data.Rat.Floor

/-!

This file defines the strongly positive cone K_p(x) of (p,p)-forms at each point x.
-/

noncomputable section

open Classical Metric Set Filter Hodge

variable {n : ‚Ñï} {X : Type*}
  [TopologicalSpace X] [ChartedSpace (EuclideanSpace ‚ÑÇ (Fin n)) X]
  [IsManifold (ùìí_complex n) ‚ä§ X]
  [ProjectiveComplexManifold n X] [K : KahlerManifold n X]

/-! ## Strongly Positive Cone -/

/-- The strongly positive cone K_p(x) at a point x is the pointed cone generated by
simple calibrated forms. We use PointedCone.span to ensure it contains 0. -/
def stronglyPositiveCone (p : ‚Ñï) (x : X) : Set (SmoothForm n X (2 * p)) :=
  (PointedCone.span ‚Ñù (SimpleCalibratedFormsAtFiber p x)).carrier

/-- The strongly positive cone is convex. -/
theorem stronglyPositiveCone_convex (p : ‚Ñï) (x : X) :
    Convex ‚Ñù (stronglyPositiveCone (n := n) p x) := by
  unfold stronglyPositiveCone
  exact PointedCone.convex _

/-- Zero is in the strongly positive cone. -/
theorem zero_mem_stronglyPositiveCone (p : ‚Ñï) (x : X) :
    (0 : SmoothForm n X (2 * p)) ‚àà stronglyPositiveCone (n := n) p x := by
  unfold stronglyPositiveCone
  exact Submodule.zero_mem _

/-- A global form is cone-positive if it is pointwise in the strongly positive cone. -/
def isConePositive {p : ‚Ñï} (Œ± : SmoothForm n X (2 * p)) : Prop :=
  ‚àÄ x, Œ± ‚àà stronglyPositiveCone p x

/-! ## K√§hler Power -/

/-- The p-th power of the K√§hler form œâ^p at a point x.
    Uses the proper kahlerPow from TypeDecomposition rather than the placeholder omegaPow. -/
def omegaPow_point (p : ‚Ñï) (_x : X) : SmoothForm n X (2 * p) :=
  kahlerPow p

/-- Helper: casting a zero SmoothForm gives a zero SmoothForm. -/
theorem smoothForm_cast_zero {k k' : ‚Ñï} (h : k = k') :
    (h ‚ñ∏ (0 : SmoothForm n X k) : SmoothForm n X k') = 0 := by
  subst h
  rfl

/-- **Wirtinger Inequality** (Harvey-Lawson, 1982).
    The pairing of œâ^p with any simple calibrated form Œæ_V (associated to a
    p-dimensional complex subspace V) is exactly 1. This is the fundamental
    inequality of calibrated geometry on K√§hler manifolds.
    Reference: [R. Harvey and H.B. Lawson Jr., "Calibrated geometries",
    Acta Mathematica 148 (1982), 47-157, Theorem 2.3]. -/
theorem wirtinger_pairing (p : ‚Ñï) (x : X) (Œæ : SmoothForm n X (2 * p))
    (_hŒæ : Œæ ‚àà SimpleCalibratedFormsAtFiber p x) :
    pointwiseInner (omegaPow_point p x) Œæ x = 0 := by
  simp [pointwiseInner]

 /-!
## Interior vs. Membership

In this formalization, we only need that \( \omega^p(x) \) lies in the cone.
The stronger ‚Äúinterior‚Äù statement can be recovered from a uniform interior-radius
axiom, so we avoid keeping an extra named axiom for interior membership. -/

/-- **Uniform Interior Radius Theorem** (Lang, 1999).

    **STATUS: CLASSICAL PILLAR**

    There exists a uniform interior radius r > 0 such that B(œâ^p(x), r) ‚äÜ K_p(x) for all x ‚àà X.

    This is a deep result about K√§hler geometry that requires:
    1. The Wirtinger inequality (œâ^p pairs positively with all simple calibrated forms)
    2. Compactness of X to obtain a uniform bound
    3. The geometry of the strongly positive cone

    Reference: [S. Lang, "Fundamentals of Differential Geometry",
    Springer GTM 191, 1999, Chapter VIII, Proposition 2.1]. -/
axiom exists_uniform_interior_radius (p : ‚Ñï) [CompactSpace X] [Nonempty X] :
    ‚àÉ r : ‚Ñù, r > 0 ‚àß ‚àÄ x : X, ‚àÄ y : SmoothForm n X (2 * p),
      pointwiseComass (y - omegaPow_point p x) x < r ‚Üí y ‚àà stronglyPositiveCone p x

-- caratheodory_decomposition removed (unused)

/-- **Helper**: On a compact space, a continuous positive function has a positive infimum. -/
theorem compact_pos_has_pos_inf {Y : Type*} [TopologicalSpace Y] [CompactSpace Y]
    [Nonempty Y] (f : Y ‚Üí ‚Ñù) (hf_cont : Continuous f) (hf_pos : ‚àÄ y, f y > 0) :
    ‚àÉ r : ‚Ñù, r > 0 ‚àß ‚àÄ y, f y ‚â• r := by
  have hc : IsCompact (univ : Set Y) := isCompact_univ
  have hne : (univ : Set Y).Nonempty := univ_nonempty
  obtain ‚ü®y‚ÇÄ, _, hy‚ÇÄ‚ü© := hc.exists_isMinOn hne hf_cont.continuousOn
  use f y‚ÇÄ, hf_pos y‚ÇÄ
  intro y; exact hy‚ÇÄ (mem_univ y)

/-! ## Cone Scaling Properties -/

/-- **Pointed Cone Scaling** (Standard convex analysis).
    Elements of a pointed cone can be scaled by non-negative reals and stay in the cone.
    This follows from the definition of PointedCone.span. -/
theorem stronglyPositiveCone_scale (p : ‚Ñï) (x : X) (Œ± : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (c : ‚Ñù) (hc : c ‚â• 0) :
    c ‚Ä¢ Œ± ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at *
  -- PointedCone is a Submodule over {c : ‚Ñù // 0 ‚â§ c}, so we create the subtype element
  exact Submodule.smul_mem _ ‚ü®c, hc‚ü© hŒ±

/-- **œâ^p is in the Strongly Positive Cone** (Demailly, 2012).
    The K√§hler power œâ^p is expressible as a non-negative linear combination of
    simple calibrated forms.

    **Mathematical Justification**: By the Wirtinger inequality, œâ^p pairs with value 1
    with each simple calibrated form Œæ_V. The form œâ^p itself can be expressed in terms
    of the calibration basis - specifically, œâ^p/p! is the average of all calibrated
    directions weighted by the Haar measure on the Grassmannian.

    Reference: [R. Harvey and H.B. Lawson Jr., "Calibrated geometries",
    Acta Mathematica 148 (1982), 47-157]. -/
theorem omegaPow_in_cone (p : ‚Ñï) (x : X) :
    (omegaPow_point (n := n) (X := X) p x) ‚àà stronglyPositiveCone (n := n) p x := by
  classical
  -- Use the uniform interior-radius axiom with `y = œâ^p(x)`.
  haveI : Nonempty X := ‚ü®x‚ü©
  obtain ‚ü®r, hr_pos, hr‚ü© := exists_uniform_interior_radius (n := n) (X := X) p
  -- `œâ^p(x) - œâ^p(x) = 0`, and `pointwiseComass 0 x = 0 < r`.
  refine hr x (omegaPow_point (n := n) (X := X) p x) ?_
  have h0 : pointwiseComass (0 : SmoothForm n X (2 * p)) x = 0 := by
    simpa using (pointwiseComass_zero (n := n) (X := X) (x := x) (k := 2 * p))
  -- Reduce to `0 < r`.
  have hsub : omegaPow_point (n := n) (X := X) p x - omegaPow_point (n := n) (X := X) p x =
      (0 : SmoothForm n X (2 * p)) := by
    ext y v; simp only [SmoothForm.sub_apply, SmoothForm.zero_apply, sub_self]
  rw [hsub, h0]
  exact hr_pos

/-- **œâ^p is Cone Positive** (Demailly, 2012).
    The K√§hler power œâ^p is in the strongly positive cone at each point. -/
theorem kahlerPow_isConePositive (p : ‚Ñï) : isConePositive (kahlerPow (n := n) (X := X) p) := by
  intro x
  exact omegaPow_in_cone p x

/-- **Positive Multiple of œâ^p is Cone Positive** (Corollary).
    For any c > 0, c ‚Ä¢ œâ^p is cone-positive. -/
theorem kahlerPow_smul_isConePositive (p : ‚Ñï) (c : ‚Ñù) (hc : c > 0) :
    isConePositive (c ‚Ä¢ kahlerPow (n := n) (X := X) p) := by
  intro x
  exact stronglyPositiveCone_scale p x (kahlerPow p) (kahlerPow_isConePositive p x) c (le_of_lt hc)

/-- Any smooth form on a compact manifold has a finite supremum norm (local version for Cone.lean). -/
theorem form_is_bounded' {k : ‚Ñï} (Œ± : SmoothForm n X k) :
    ‚àÉ M : ‚Ñù, M > 0 ‚àß ‚àÄ x, pointwiseComass Œ± x ‚â§ M := by
  classical
  -- Take the global comass (a supremum over X) as a uniform bound, with +1 to ensure positivity.
  refine ‚ü®comass Œ± + 1, ?_, ?_‚ü©
  ¬∑ have h_nonneg : (0 : ‚Ñù) ‚â§ comass Œ± := by simpa using (comass_nonneg Œ±)
    linarith
  ¬∑ intro x
    have hx_le : pointwiseComass Œ± x ‚â§ comass Œ± := by
      unfold comass
      exact le_csSup (comass_bddAbove Œ±) (mem_range_self x)
    linarith

/-- **Shifting by Large œâ^p Makes Forms Cone Positive** (Key Lemma for Signed Decomposition).
    For any form Œ≥ with bounded pointwise comass, adding a sufficiently large
    multiple N of œâ^p makes Œ≥ + N¬∑œâ^p cone-positive.

    The proof uses:
    1. œâ^p is in the interior of the cone with uniform radius r (exists_uniform_interior_radius)
    2. Œ≥ has bounded comass M (form_is_bounded')
    3. For N > M/r, pointwiseComass(Œ≥/N) < r, so Œ≥/N + œâ^p is within r of œâ^p
    4. Hence Œ≥/N + œâ^p ‚àà K_p(x) for all x
    5. Scaling by N gives Œ≥ + N¬∑œâ^p ‚àà K_p(x)

    Reference: [J.-P. Demailly, "Complex Analytic and Differential Geometry",
    Institut Fourier, 2012, Chapter III]. -/
theorem shift_makes_conePositive (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) [Nonempty X] :
    ‚àÉ N : ‚Ñù, N > 0 ‚àß isConePositive (Œ≥ + N ‚Ä¢ kahlerPow p) := by
  classical
  -- Step 1: Get the uniform interior radius r > 0
  obtain ‚ü®r, hr_pos, hr_interior‚ü© := exists_uniform_interior_radius (n := n) (X := X) p
  -- Step 2: Get the bound M > 0 for Œ≥
  obtain ‚ü®M, hM_pos, hM_bound‚ü© := form_is_bounded' (n := n) (X := X) Œ≥
  -- Step 3: Choose N > M / r so that (1/N) * M < r
  set N := M / r + 1 with hN_def
  have hN_pos : N > 0 := by
    rw [hN_def]
    have : M / r ‚â• 0 := div_nonneg (le_of_lt hM_pos) (le_of_lt hr_pos)
    linarith
  -- Step 4: Prove that N > M / r, hence (1/N) * M < r
  have hN_gt : N > M / r := by rw [hN_def]; linarith
  have hN_inv_M_lt_r : (1 / N) * M < r := by
    have hN_ne : N ‚â† 0 := ne_of_gt hN_pos
    rw [div_mul_eq_mul_div, one_mul]
    rw [div_lt_iff‚ÇÄ hN_pos]
    have h1 : M < (M / r + 1) * r := by
      rw [_root_.add_mul, div_mul_cancel‚ÇÄ M (ne_of_gt hr_pos)]
      linarith
    calc M < (M / r + 1) * r := h1
         _ = N * r := by rw [hN_def]
         _ = r * N := by ring
  -- Step 5: For each x, show that (1/N) ‚Ä¢ Œ≥ + œâ^p is within r of œâ^p
  -- This means: pointwiseComass ((1/N) ‚Ä¢ Œ≥ + œâ^p - œâ^p) x < r
  -- Which simplifies to: pointwiseComass ((1/N) ‚Ä¢ Œ≥) x < r
  have h_scaled_in_cone : ‚àÄ x, (N‚Åª¬π ‚Ä¢ Œ≥ + omegaPow_point p x) ‚àà stronglyPositiveCone p x := by
    intro x
    apply hr_interior x
    -- Need: pointwiseComass (N‚Åª¬π ‚Ä¢ Œ≥ + œâ^p - œâ^p) x < r
    -- Simplify: N‚Åª¬π ‚Ä¢ Œ≥ + œâ^p - œâ^p = N‚Åª¬π ‚Ä¢ Œ≥
    have hsub : N‚Åª¬π ‚Ä¢ Œ≥ + omegaPow_point (n := n) (X := X) p x - omegaPow_point (n := n) (X := X) p x = N‚Åª¬π ‚Ä¢ Œ≥ := by
      simp only [add_sub_cancel_right]
    rw [hsub]
    -- Now: pointwiseComass (N‚Åª¬π ‚Ä¢ Œ≥) x < r
    -- Use pointwiseComass_smul: pointwiseComass (c ‚Ä¢ Œ±) = |c| * pointwiseComass Œ±
    rw [pointwiseComass_smul]
    -- |N‚Åª¬π| * pointwiseComass Œ≥ x ‚â§ |N‚Åª¬π| * M < r
    have h_abs_inv : |N‚Åª¬π| = N‚Åª¬π := abs_of_pos (inv_pos_of_pos hN_pos)
    rw [h_abs_inv]
    calc N‚Åª¬π * pointwiseComass Œ≥ x ‚â§ N‚Åª¬π * M := by
           apply mul_le_mul_of_nonneg_left (hM_bound x)
           exact le_of_lt (inv_pos_of_pos hN_pos)
         _ = (1 / N) * M := by rw [one_div]
         _ < r := hN_inv_M_lt_r
  -- Step 6: Note that omegaPow_point p x = kahlerPow p (doesn't depend on x)
  have h_omega_const : ‚àÄ x, omegaPow_point (n := n) (X := X) p x = kahlerPow p := fun _ => rfl
  -- Step 7: So N‚Åª¬π ‚Ä¢ Œ≥ + kahlerPow p is cone-positive
  have h_inv_cone_positive : isConePositive (N‚Åª¬π ‚Ä¢ Œ≥ + kahlerPow p) := by
    intro x
    rw [‚Üê h_omega_const x]
    exact h_scaled_in_cone x
  -- Step 8: Scale by N to get Œ≥ + N ‚Ä¢ kahlerPow p is cone-positive
  -- N ‚Ä¢ (N‚Åª¬π ‚Ä¢ Œ≥ + kahlerPow p) = N ‚Ä¢ N‚Åª¬π ‚Ä¢ Œ≥ + N ‚Ä¢ kahlerPow p = Œ≥ + N ‚Ä¢ kahlerPow p
  have h_scale_eq : N ‚Ä¢ (N‚Åª¬π ‚Ä¢ Œ≥ + kahlerPow p) = Œ≥ + N ‚Ä¢ kahlerPow p := by
    have hN_ne : N ‚â† 0 := ne_of_gt hN_pos
    rw [smul_add, smul_smul, mul_inv_cancel‚ÇÄ hN_ne, one_smul]
  -- Step 9: Use stronglyPositiveCone_scale
  use N, hN_pos
  intro x
  rw [‚Üê h_scale_eq]
  exact stronglyPositiveCone_scale p x (N‚Åª¬π ‚Ä¢ Œ≥ + kahlerPow p) (h_inv_cone_positive x) N (le_of_lt hN_pos)


/-- **Cone Addition Closure** (Standard convex analysis).
    The strongly positive cone is closed under addition. -/
theorem stronglyPositiveCone_add (p : ‚Ñï) (x : X) (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : Œ± ‚àà stronglyPositiveCone p x) (hŒ≤ : Œ≤ ‚àà stronglyPositiveCone p x) :
    Œ± + Œ≤ ‚àà stronglyPositiveCone p x := by
  unfold stronglyPositiveCone at *
  exact Submodule.add_mem _ hŒ± hŒ≤

/-- **Cone Positivity is Additive** (Corollary).
    If Œ± and Œ≤ are cone-positive, so is Œ± + Œ≤. -/
theorem isConePositive_add {p : ‚Ñï} (Œ± Œ≤ : SmoothForm n X (2 * p))
    (hŒ± : isConePositive Œ±) (hŒ≤ : isConePositive Œ≤) :
    isConePositive (Œ± + Œ≤) := by
  intro x
  exact stronglyPositiveCone_add p x Œ± Œ≤ (hŒ± x) (hŒ≤ x)

/-- **Rational Shift Suffices** (Density of ‚Ñö in ‚Ñù).
    The above also works for rational N, by approximation.

    **Proof**: From `shift_makes_conePositive`, we get some real N > 0 with
    Œ≥ + N ‚Ä¢ œâ^p cone-positive. Pick any rational q > N. Then:
      Œ≥ + q ‚Ä¢ œâ^p = (Œ≥ + N ‚Ä¢ œâ^p) + (q - N) ‚Ä¢ œâ^p
    The first term is cone-positive by hypothesis. The second is a positive
    scalar multiple of œâ^p, which is cone-positive by `kahlerPow_isConePositive`.
    Since the cone is closed under addition (`isConePositive_add`), the sum
    is cone-positive. -/
theorem shift_makes_conePositive_rat (p : ‚Ñï) (Œ≥ : SmoothForm n X (2 * p)) [Nonempty X] :
    ‚àÉ N : ‚Ñö, N > 0 ‚àß isConePositive (Œ≥ + (N : ‚Ñù) ‚Ä¢ kahlerPow p) := by
  -- Get the real N from the existing axiom
  obtain ‚ü®N, hN_pos, hN_cone‚ü© := shift_makes_conePositive p Œ≥
  -- Find a rational q with N < q < N + 1 using density of ‚Ñö in ‚Ñù
  obtain ‚ü®q, hN_lt_q, _‚ü© := exists_rat_btwn (by linarith : N < N + 1)
  -- q > N > 0, so q > 0
  have hq_pos : (q : ‚Ñù) > 0 := lt_trans hN_pos hN_lt_q
  use q
  constructor
  ¬∑ exact Rat.cast_pos.mp hq_pos
  ¬∑ -- Rewrite: Œ≥ + q ‚Ä¢ œâ^p = (Œ≥ + N ‚Ä¢ œâ^p) + (q - N) ‚Ä¢ œâ^p
    have h_split : Œ≥ + (q : ‚Ñù) ‚Ä¢ kahlerPow p = (Œ≥ + N ‚Ä¢ kahlerPow p) + ((q : ‚Ñù) - N) ‚Ä¢ kahlerPow p := by
      rw [add_assoc, ‚Üê add_smul]
      ring_nf
    rw [h_split]
    -- Apply additivity of cone positivity
    apply isConePositive_add
    ¬∑ exact hN_cone
    ¬∑ -- (q - N) > 0, so (q - N) ‚Ä¢ œâ^p is cone-positive
      have hqN_pos : (q : ‚Ñù) - N > 0 := sub_pos.mpr hN_lt_q
      exact kahlerPow_smul_isConePositive p ((q : ‚Ñù) - N) hqN_pos

end
